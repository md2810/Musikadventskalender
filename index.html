<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musikadventskalender</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="cards">
        <div class="title-card">
            <h1>Musikadventskalender</h1>
        </div>
        <div id="spotify-container">
            <div id="now-playing" class="spotify-card">
                <div id="song-cover" class="cover"></div>
                <div>
                    <p id="song-title">Kein Song</p>
                    <p id="artist-name">Keine Wiedergabe</p>
                </div>
            </div>
            <button id="login-button" style="display: none;" onclick="window.location.href='/login'">Spotify Login</button>
            <div id="no-song-card" class="notplaying-card" style="display: none;">
                <p>Gleich geht es los...</p>
            </div>
        </div>
    </div>
    <script>
        const spotifyCard = document.getElementById("now-playing");
        const noSongCard = document.getElementById("no-song-card");
        const loginButton = document.getElementById("login-button");
        let currentSongCover = "";

        async function updateNowPlaying() {
            const response = await fetch("/now-playing");
            if (response.status === 401) {
                spotifyCard.classList.remove("show");
                noSongCard.classList.remove("show");
                loginButton.style.display = "block";
                return;
            }

            if (response.ok) {
                const data = await response.json();
                if (data.is_playing) {
                    spotifyCard.classList.add("show");
                    noSongCard.classList.remove("show");
                    loginButton.style.display = "none";
                    document.getElementById("song-title").innerText = data.item.name;
                    document.getElementById("artist-name").innerText = data.item.artists.map(a => a.name).join(", ");
                    const songCover = data.item.album.images[0].url;
                    document.getElementById("song-cover").style.backgroundImage = `url(${songCover})`;

                    if (songCover !== currentSongCover) {
                        currentSongCover = songCover;
                        setDynamicBackground(songCover);
                    }
                } else {
                    spotifyCard.classList.remove("show");
                    noSongCard.classList.add("show");
                }
            } else {
                loginButton.style.display = "block";
            }
        }

        async function setDynamicBackground(imageUrl) {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = imageUrl;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0, canvas.width, canvas.height);
                const data = context.getImageData(0, 0, canvas.width, canvas.height).data;

                const totalPixels = data.length / 4;
                let r1 = 0, g1 = 0, b1 = 0, r2 = 0, g2 = 0, b2 = 0;

                for (let i = 0; i < totalPixels / 2; i++) {
                    r1 += data[i * 4];
                    g1 += data[i * 4 + 1];
                    b1 += data[i * 4 + 2];
                }

                for (let i = totalPixels / 2; i < totalPixels; i++) {
                    r2 += data[i * 4];
                    g2 += data[i * 4 + 1];
                    b2 += data[i * 4 + 2];
                }

                const gradient = `linear-gradient(to bottom, rgb(${Math.floor(r1 / (totalPixels / 2))},${Math.floor(g1 / (totalPixels / 2))},${Math.floor(b1 / (totalPixels / 2))}), rgb(${Math.floor(r2 / (totalPixels / 2))},${Math.floor(g2 / (totalPixels / 2))},${Math.floor(b2 / (totalPixels / 2))}))`;
                document.body.style.background = gradient;
            };
        }

        window.addEventListener("load", () => {
            setInterval(updateNowPlaying, 1000);
        });
    </script>
</body>
</html>
