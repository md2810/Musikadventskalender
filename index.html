<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Now Playing</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="spotify-container">
        <div id="now-playing" class="spotify-card" style="display: none;">
            <div id="song-cover" class="cover"></div>
            <div>
                <div id="song-title">Song Title</div>
                <div id="artist-name">Artist Name</div>
            </div>
        </div>

        <div id="login-button" style="display: none;">
            <button id="login-button">Log in to Spotify</button>
        </div>
    </div>

    <script>
        const spotifyContainer = document.getElementById("spotify-container");
        const spotifyCard = document.getElementById("now-playing");
        const loginButton = document.getElementById("login-button");

        async function updateNowPlaying() {
            const response = await fetch("/now-playing");
            if (response.status === 401) {
                spotifyCard.style.display = "none";
                if (loginButton) {
                    loginButton.style.display = "block";
                }
                return;
            }

            if (response.ok) {
                const data = await response.json();
                if (data && data.is_playing) {
                    spotifyCard.style.display = "flex";
                    if (loginButton) {
                        loginButton.style.display = "none";
                    }
                    document.getElementById("song-title").innerText = data.item.name;
                    document.getElementById("artist-name").innerText = data.item.artists
                        .map((artist) => artist.name)
                        .join(", ");
                    const songCover = data.item.album.images[0].url;
                    document.getElementById("song-cover").style.backgroundImage = `url(${songCover})`;

                    // Hintergrund mit Farbverlauf aktualisieren
                    setDynamicBackground(songCover);
                } else {
                    spotifyCard.style.display = "none";
                    if (loginButton) {
                        loginButton.style.display = "none";
                    }
                }
            } else {
                spotifyCard.style.display = "none";
                if (loginButton) {
                    loginButton.style.display = "block";
                }
            }
        }

        async function setDynamicBackground(imageUrl) {
            try {
                // Bild laden und Canvas verwenden
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Wichtig, um CORS-Fehler zu vermeiden
                img.src = imageUrl;

                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // Zeichne das Bild auf das Canvas
                    context.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Hol die Bilddaten
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;

                    // Extrahiere Farben (einfacher Ansatz: Durchschnittsfarben)
                    let r1 = 0, g1 = 0, b1 = 0, r2 = 0, g2 = 0, b2 = 0;
                    const totalPixels = imageData.length / 4;

                    for (let i = 0; i < totalPixels / 2; i++) {
                        r1 += imageData[i * 4];
                        g1 += imageData[i * 4 + 1];
                        b1 += imageData[i * 4 + 2];
                    }

                    for (let i = totalPixels / 2; i < totalPixels; i++) {
                        r2 += imageData[i * 4];
                        g2 += imageData[i * 4 + 1];
                        b2 += imageData[i * 4 + 2];
                    }

                    // Durchschnitt berechnen
                    r1 = Math.floor(r1 / (totalPixels / 2));
                    g1 = Math.floor(g1 / (totalPixels / 2));
                    b1 = Math.floor(b1 / (totalPixels / 2));
                    r2 = Math.floor(r2 / (totalPixels / 2));
                    g2 = Math.floor(g2 / (totalPixels / 2));
                    b2 = Math.floor(b2 / (totalPixels / 2));

                    // Generiere Farbverlauf
                    const gradient = `linear-gradient(to bottom, rgb(${r1},${g1},${b1}), rgb(${r2},${g2},${b2}))`;
                    document.body.style.transition = "background 1s ease"; // Ãœbergangseffekt
                    document.body.style.background = gradient;
                };
            } catch (error) {
                console.error("Fehler beim Generieren des Hintergrunds:", error);
            }
        }

        setInterval(updateNowPlaying, 1000);
    </script>
</body>
</html>
