<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Musikadventskalender</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="title-card">
        <h1>Musikadventskalender</h1>
    </div>

    <div id="spotify-container">
        <div id="now-playing" class="spotify-card">
            <div id="song-cover" class="cover"></div>
            <div>
                <p id="song-title">Kein Song</p>
                <p id="artist-name">Keine Wiedergabe</p>
            </div>
        </div>
        <button id="login-button" style="display: none;" onclick="window.location.href='/login'">Spotify Login</button>
        <div class="notplaying-card" style="display: none;">
            <p>Gleich geht es los...</p>
        </div>
        
    </div>

    <script>
        const spotifyContainer = document.getElementById("spotify-container");
        const spotifyCard = document.getElementById("now-playing");
        const noSongCard = document.getElementById("no-song-card");
        const loginButton = document.getElementById("login-button");
    
        async function updateNowPlaying() {
            const response = await fetch("/now-playing");
            if (response.status === 401) {
                spotifyCard.style.display = "none";
                noSongCard.style.display = "none";
                if (loginButton) {
                    loginButton.style.display = "block";
                }
                return;
            }
    
            if (response.ok) {
                const data = await response.json();
                if (data && data.is_playing) {
                    // Song wird abgespielt, zeige die Spotify-Karte
                    spotifyCard.style.display = "flex";
                    noSongCard.style.display = "none"; // Verstecke die "Gleich geht es los..."-Karte
                    if (loginButton) {
                        loginButton.style.display = "none";
                    }
                    document.getElementById("song-title").innerText = data.item.name;
                    document.getElementById("artist-name").innerText = data.item.artists
                        .map((artist) => artist.name)
                        .join(", ");
                    const songCover = data.item.album.images[0].url;
                    document.getElementById("song-cover").style.backgroundImage = `url(${songCover})`;
    
                    // Hintergrund mit Farbverlauf aktualisieren
                    setDynamicBackground(songCover);
                } else {
                    // Kein Song wird abgespielt, zeige die "Gleich geht es los..."-Karte
                    spotifyCard.style.display = "none";
                    noSongCard.style.display = "flex"; // Zeige die "Gleich geht es los..."-Karte
                    if (loginButton) {
                        loginButton.style.display = "none";
                    }
                }
            } else {
                spotifyCard.style.display = "none";
                noSongCard.style.display = "none";
                if (loginButton) {
                    loginButton.style.display = "block";
                }
            }
        }
    
        async function setDynamicBackground(imageUrl) {
            try {
                // Bild laden und Canvas verwenden
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Wichtig, um CORS-Fehler zu vermeiden
                img.src = imageUrl;
    
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.width = img.width;
                    canvas.height = img.height;
    
                    // Zeichne das Bild auf das Canvas
                    context.drawImage(img, 0, 0, canvas.width, canvas.height);
    
                    // Hol die Bilddaten
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;
    
                    // Extrahiere Farben (einfacher Ansatz: Durchschnittsfarben)
                    let r1 = 0, g1 = 0, b1 = 0, r2 = 0, g2 = 0, b2 = 0;
                    const totalPixels = imageData.length / 4;
    
                    for (let i = 0; i < totalPixels / 2; i++) {
                        r1 += imageData[i * 4];
                        g1 += imageData[i * 4 + 1];
                        b1 += imageData[i * 4 + 2];
                    }
    
                    for (let i = totalPixels / 2; i < totalPixels; i++) {
                        r2 += imageData[i * 4];
                        g2 += imageData[i * 4 + 1];
                        b2 += imageData[i * 4 + 2];
                    }
    
                    // Durchschnitt berechnen
                    r1 = Math.floor(r1 / (totalPixels / 2));
                    g1 = Math.floor(g1 / (totalPixels / 2));
                    b1 = Math.floor(b1 / (totalPixels / 2));
                    r2 = Math.floor(r2 / (totalPixels / 2));
                    g2 = Math.floor(g2 / (totalPixels / 2));
                    b2 = Math.floor(b2 / (totalPixels / 2));
    
                    // Generiere Farbverlauf
                    const gradient = `linear-gradient(to bottom, rgb(${r1},${g1},${b1}), rgb(${r2},${g2},${b2}))`;
                    document.body.style.background = gradient;
                };
            } catch (error) {
                console.error("Fehler beim Generieren des Hintergrunds:", error);
            }
        }
    
        setInterval(updateNowPlaying, 1000);
    </script>
</body>
</html>
